//
//  ImagePreviewController.m
//  CBClient
//
//  Created by ji-chang-an on 15/6/19.
//  Copyright (c) 2015年 chebao. All rights reserved.
//

#import "ImagePreviewController.h"

#import "ImageIndexViewController.h"

#import "ImagePreviewControllerTransitioningDelegate.h"

#pragma mark - ImageAbstractPageController
@interface ImageAbstractPageController : UIPageViewController
@end
@implementation ImageAbstractPageController
- (BOOL)prefersStatusBarHidden {
    return YES;
}
- (UIStatusBarAnimation)preferredStatusBarUpdateAnimation {
    return UIStatusBarAnimationFade;
}
@end

#pragma mark - ImagePreviewController
@interface ImagePreviewController () <UIPageViewControllerDataSource, UIPageViewControllerDelegate>

@property (nonatomic, copy) NSArray<ImagePreviewObject *> *images;
@property (nonatomic, strong) ImagePreviewObject *currentImage;

@property (nonatomic, strong) UIPageControl *pageControl;

@property (nonatomic, strong) ImagePreviewControllerTransitioningDelegate *imagePreviewControllerTransitioningDelegate;

@property (nonatomic, strong, readwrite) UIPageViewController *pageViewController;

@end

@implementation ImagePreviewController

- (void)dealloc {}

+ (ImagePreviewController *)controllerWithImage:(ImagePreviewObject *)image images:(NSArray<ImagePreviewObject *> *)images {
    UIPageViewController *pageVC = [[ImageAbstractPageController alloc] initWithTransitionStyle:UIPageViewControllerTransitionStyleScroll navigationOrientation:UIPageViewControllerNavigationOrientationHorizontal options:@{UIPageViewControllerOptionInterPageSpacingKey:@(20)}];
    
    ImagePreviewController *controller = [[ImagePreviewController alloc] initWithRootViewController:pageVC];
    pageVC.delegate = controller;
    pageVC.dataSource = controller;
    
    //初始
    ImageIndexViewController *indexVC = [[ImageIndexViewController alloc] initWithImage:image];
    indexVC.firstShowAnimated = YES;
    [pageVC setViewControllers:@[indexVC] direction:UIPageViewControllerNavigationDirectionForward animated:NO completion:nil];
    
    
    controller.currentImage = image;
    controller.images = images;
    controller.pageViewController = pageVC;
    
    return controller;
}

- (instancetype)initWithRootViewController:(UIViewController *)rootViewController {
    self = [super initWithRootViewController:rootViewController];
    if (self) {
        self.imagePreviewControllerTransitioningDelegate = [[ImagePreviewControllerTransitioningDelegate alloc] init];
    }
    return self;
}

- (void)viewDidLoad {
    [super viewDidLoad];
    self.navigationBarHidden = YES;
    self.view.backgroundColor = [UIColor blackColor];
    self.view.clipsToBounds = YES;
}

- (void)viewWillAppear:(BOOL)animated {
    [super viewWillAppear:animated];
    //针对非vc控制状态栏显示与否
    [[UIApplication sharedApplication] setStatusBarHidden:YES withAnimation:UIStatusBarAnimationFade];
}

- (void)viewDidAppear:(BOOL)animated {
    [super viewDidAppear:animated];
    [self loadPageControl];
}

- (void)viewWillDisappear:(BOOL)animated {
    self.pageControl.hidden = YES;
    //针对非vc控制状态栏显示与否
    [[UIApplication sharedApplication] setStatusBarHidden:NO withAnimation:UIStatusBarAnimationFade];
    [super viewWillDisappear:animated];
}

- (void)loadPageControl {
    if (self.images.count < 2) {
        self.pageControl.hidden = YES;
        return;
    }
    
    if (self.pageControl.superview != self.view) {
        [self.view addSubview:self.pageControl];
    }
    CGRect frame = self.pageControl.frame;
    frame.origin.x = (self.view.frame.size.width - frame.size.width)/2;
    frame.origin.y = (self.view.frame.size.height - frame.size.height) - 20;
    self.pageControl.frame = frame;
    self.pageControl.numberOfPages = self.images.count;
    self.pageControl.currentPage = [self indexOfImagePreviewObject:self.currentImage];
  
    self.pageControl.hidden = NO;
}

- (UIPageControl *)pageControl {
    if (!_pageControl) {
        _pageControl = [[UIPageControl alloc] init];
        _pageControl.pageIndicatorTintColor = [UIColor lightGrayColor];
        _pageControl.currentPageIndicatorTintColor = [UIColor whiteColor];
    }
    return _pageControl;
}

- (NSUInteger)indexOfImagePreviewObject:(ImagePreviewObject *)imagePreviewObject {
    for (NSUInteger i = 0; i < self.images.count; ++i) {
        ImagePreviewObject *one = self.images[i];
        if ([imagePreviewObject isEqualToImagePreviewObject:one]) {
            return i;
        }
    }
    return NSNotFound;
}

- (UIViewController *)pageViewController:(UIPageViewController *)pageViewController viewControllerBeforeViewController:(UIViewController *)viewController {
    
    ImagePreviewObject *imagePreviewObject = ((ImageIndexViewController *)viewController).imagePreviewObject;
    
    NSUInteger index = [self indexOfImagePreviewObject:imagePreviewObject];
    if (index == 0) {
        return nil;
    }

    ImageIndexViewController *indexVCBefore = [[ImageIndexViewController alloc] initWithImage:self.images[index-1]];
    return indexVCBefore;
}

- (UIViewController *)pageViewController:(UIPageViewController *)pageViewController viewControllerAfterViewController:(UIViewController *)viewController {
    ImagePreviewObject *imagePreviewObject = ((ImageIndexViewController *)viewController).imagePreviewObject;
    
    NSUInteger index = [self indexOfImagePreviewObject:imagePreviewObject];
    if (index+1 >= [self presentationCountForPageViewController:pageViewController]) {
        return nil;
    }
    
    ImageIndexViewController *indexVCAfter = [[ImageIndexViewController alloc] initWithImage:self.images[index+1]];
    return indexVCAfter;
}

- (void)pageViewController:(UIPageViewController *)pageViewController didFinishAnimating:(BOOL)finished previousViewControllers:(NSArray<UIViewController *> *)previousViewControllers transitionCompleted:(BOOL)completed {
    if (!completed) {
        return;
    }
    
    // Find index of current page
    ImageIndexViewController *currentViewController = (ImageIndexViewController *)[pageViewController.viewControllers lastObject];
    
    NSUInteger index = [self indexOfImagePreviewObject:currentViewController.imagePreviewObject];
    self.pageControl.currentPage = index;
    
    self.currentImage = currentViewController.imagePreviewObject;
}

- (NSInteger)presentationCountForPageViewController:(UIPageViewController *)pageViewController {
    return self.images.count;
}

//- (NSInteger)presentationIndexForPageViewController:(UIPageViewController *)pageViewController
//{
//    NSInteger countForPageViewController = [self presentationCountForPageViewController:pageViewController];
//    
//    //少于2个不展示
//    if (countForPageViewController < 2)
//    {
//        return -1;
//    }
//    
//    NSUInteger index = [self indexOfImagePreviewObject:self.currentImage];
//    
//    return index;
//}


//暂时直接覆盖这个@property (nullable, nonatomic, weak) id <UIViewControllerTransitioningDelegate> transitioningDelegate NS_AVAILABLE_IOS(7_0);
- (id<UIViewControllerTransitioningDelegate>)transitioningDelegate {
    return self.imagePreviewControllerTransitioningDelegate;
}

- (UIModalPresentationStyle)modalPresentationStyle {
    return UIModalPresentationFullScreen;
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end


